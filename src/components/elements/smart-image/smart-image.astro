---
import { getProviderForUrl } from "unpic";
import AstroImage from "./astro-image.astro";
import UnpicImage from "./unpic-image.astro";

const {
  source,
  alt,
  sizes = "(min-width: 30em) 50vw, 100vw",
  widths = [400, 600, 800, 1200, 1600],
  rounded = false,
  priority,
  aspectRatio = null,
  positionVertical = "center",
  positionHorizontal = "center",
  editable = false,
  class: className,
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => key !== "_component")
);

const hasValidSrc = source && typeof source === "string" && source.trim() !== "";

const provider = hasValidSrc ? getProviderForUrl(source) : false;
const isExternalCDN = provider !== false;

const commonProps = {
  alt: alt || "",
};

const dataAttributes = !editable
  ? {
      "data-editable": "image",
      "data-prop-src": "source",
      "data-prop-alt": "alt",
    }
  : {};

const positionClass = `position-${positionVertical}-${positionHorizontal}`;
---

<div
  class:list={[
    "smart-image",
    aspectRatio && "ratio",
    aspectRatio && `ratio-${aspectRatio}`,
    positionClass,
    rounded && "rounded",
    className,
  ]}
  {...htmlAttributes}
>
  {
    hasValidSrc ? (
      isExternalCDN ? (
        <UnpicImage
          {...commonProps}
          {...dataAttributes}
          source={source}
          sizes={sizes}
          widths={widths}
          priority={priority}
        />
      ) : (
        <AstroImage
          {...commonProps}
          {...dataAttributes}
          source={source}
          sizes={sizes}
          widths={widths}
          priority={priority}
        />
      )
    ) : (
      <picture>
        <img {...dataAttributes} src={source} alt={alt || ""} />
      </picture>
    )
  }
</div>
