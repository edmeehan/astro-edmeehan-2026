---
import { getCollection } from "astro:content";
import ComponentLayout from "../../layouts/ComponentLayout.astro";

export async function getStaticPaths() {
  const schemaFiles = import.meta.glob("../../../../shared/components/**/schema.ts", {
    eager: true,
  });

  const components = await getCollection("components");

  const componentEntries = components.filter((entry) => {
    // Exclude files that are in examples directories
    return !entry.slug.includes("/examples/");
  });

  return componentEntries.map((entry) => {
    const slug = entry.slug.replace(/^components\//, "").replace(/\/index$/, "");
    const parts = slug.split("/").filter(Boolean);
    const componentKey = parts.slice(-2).join("/");

    let schema = null;

    for (const [path, mod] of Object.entries(schemaFiles)) {
      if (path.toLowerCase().includes(`/${componentKey.toLowerCase()}/`)) {
        const module = mod as { [key: string]: { meta?: () => { description?: string } } };
        const schemaName = Object.keys(module).find((key) => key.endsWith("Schema"));

        if (schemaName) {
          schema = module[schemaName];
        }
        break;
      }
    }

    return {
      params: { slug: componentKey },
      props: { page: entry, schema },
    };
  });
}

const { page, schema } = Astro.props;
const { Content, ...frontmatter } = await page.render();

const slugParts = page.slug
  .replace(/^components\//, "")
  .replace(/\/index$/, "")
  .split("/")
  .filter(Boolean);

const componentKey = slugParts.slice(-2).join("/");

const searchPattern = `${componentKey}/examples/`.toLowerCase();

const examples = await getCollection("components", ({ slug }) => {
  return slug.toLowerCase().startsWith(searchPattern);
});
---

<ComponentLayout frontmatter={frontmatter} schema={schema} examples={examples}>
  <Content />

  {
    examples.length > 0 && (
      <div style="margin: 2rem 0;">
        <h2>Examples</h2>
        {examples.map(async (example: any) => {
          const { Content: ExampleContent } = await example.render();

          return (
            <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; background: white; padding: 1rem; margin-bottom: 1rem;">
              <ExampleContent />
            </div>
          );
        })}
      </div>
    )
  }
</ComponentLayout>
